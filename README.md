# Manage your LUIS Application via Bot Builder tools

In this tutorial we'll export an existing LUIS application then modify it with ludown and luis-cli. After that we'll publish it and generate C# class for bot service integration.

## Prerequisite

- [Node.js](https://nodejs.org/) version 8.5 or higher

## Installation

To install:
```bash
npm i -g ludown , luis-apis , luisgen
```


To set your luis account we'll use 'luis init' for it.
```bash
luis init
```

```bash
luis init

This util will walk you through creating a .luisrc file

Press ^C at any time to quit.

What is your LUIS Authoring key (from luis.ai portal User Settings page)? YOUR_AUTHORING_KEY
What is your region? [westus, westeurope, australiaeast] westeurope
What is your LUIS App ID? [Default: skip]

Does this look ok?
{
  "authoringKey": "YOUR_AUTHORING_KEY",
  "region": "westeurope"
}
[Yes]/No: yes
Successfully wrote C:\Users\ikivanc\OneDrive - Microsoft\Docs\Projects\Bots\LUIS/.luisrc
```


## List All LUIS Apps
If you don't have a LUIS application on your account, you can use ["supportservice.json"](./supportservice.json) file and you can jump to "Update your LUIS Model" section.

List all your application on your LUIS account. 
```bash
luis list apps --skip <integer> --take <integer>
```

## Export a LUIS Apps
Export your LUIS application into json file.
```bash
luis export version --appId <string> --versionId <string> > supportservice.json
```

## Update your LUIS Model

Convert JSON LUIS model to .lu text file:
```bash
ludown refresh -i supportservice.json -n supportservicetext.lu
```

Modify the LUIS base with your new additional intent and entity.
In below case I'll only add a new intent and 3 new entities.

Add Entities:
```bash
> # Entity definitions

$ServiceItem.Hardware:simple

$ServiceItem.OfficeGoods:simple

$ServiceItem.Software:simple
```

Add below utterances for CreateServiceRequest
```bash
## CreateServiceRequest
- {ServiceItem.Software=portal} {ServiceItem.Software=website} is not working
- {ServiceItem.Software=excel} is crashing
- {ServiceItem.Software=excel} is not working
- {ServiceItem.Software=firefox} is not working
- i have a problem with my {ServiceItem.Hardware=laptop}
- i have an issue with my {ServiceItem.Hardware=keyboard}
- i have an issue with my {ServiceItem.OfficeGoods=printer}
- i need a guidance for my {ServiceItem.Hardware=monitor}
- i want to get an help for {ServiceItem.Hardware=screen}
- {ServiceItem.Hardware=laptop charger} is not working
- {ServiceItem.Hardware=laptop} is not working
- my {ServiceItem.Hardware=monitor} is not working
- my {ServiceItem.Hardware=mouse} is not working
- {ServiceItem.Software=outlook} is not working
- {ServiceItem.Software=powerpoint} is not working
- {ServiceItem.OfficeGoods=printer} is not working
- {ServiceItem.Software=word} is not working
- {ServiceItem.Software} is not working
- {ServiceItem.Hardware} is not working
- {ServiceItem.Hardware} is broken
```

After changes convert .lu file to json file.

```bash
ludown parse ToLuis --in supportservicetext.lu -n supportserviceupdated -i 0.1
```

Import LUIS json file.
```bash
luis import application --in supportserviceupdated.json
```
output: 
```bash
{
  "id": "YOUR-LUIS-PROJECT-ID",
  "name": "supportserviceupdated",
  "description": "",
  "culture": "en-us",
  "usageScenario": "",
  "domain": "",
  "versionsCount": 1,
  "createdDateTime": "2018-10-01T21:46:57Z",
  "endpoints": {},
  "endpointHitsCount": 0,
  "activeVersion": "0.1"
}
```

Your modified LUIS project is updated.

## Train and Publish
You can easily train + publish your model by selecting Train  in the web portal. If you’d like to instead use the LUIS API tool to train or publish from the command line, you’ll need to grab the App ID from the web portal.

Train your LUIS model:
```bash
luis train version --appId <appId> --versionId <versionId>
```

Publish your LUIS model:
```bash
luis publish version --in supportserviceupdated.json --appId <string> --versionId 0.1 --region westeurope --isStaging false
```


## Generate LUIS Class using Luisgen
Generating file LuisResultModel.cs that contains class Luis.LuisResultModel.

```bash
luisgen supportserviceupdated.json -cs LuisResultModel
```

C# model output will be like below:
```csharp
// <auto-generated>
// Code generated by LUISGen supportserviceupdated.json -cs Luis.LuisResultModel -o 
// Tool github: https://github.com/microsoft/botbuilder-tools
// Changes may cause incorrect behavior and will be lost if the code is
// regenerated.
// </auto-generated>
using Newtonsoft.Json;
using System.Collections.Generic;
using Microsoft.Bot.Builder;
using Microsoft.Bot.Builder.AI.Luis;
namespace Luis
{
    public class LuisResultModel: IRecognizerConvert
    {
        public string Text;
        public string AlteredText;
        public enum Intent {
            Cancel, 
            Greeting, 
            Help, 
            None, 
            CreateServiceRequest
        };
        public Dictionary<Intent, IntentScore> Intents;

        public class _Entities
        {
            // Simple entities
            public string[] ServiceItem_Software;
            public string[] ServiceItem_Hardware;
            public string[] ServiceItem_OfficeGoods;

            // Instance
            public class _Instance
            {
                public InstanceData[] ServiceItem_Software;
                public InstanceData[] ServiceItem_Hardware;
                public InstanceData[] ServiceItem_OfficeGoods;
            }
            [JsonProperty("$instance")]
            public _Instance _instance;
        }
        public _Entities Entities;

        [JsonExtensionData(ReadData = true, WriteData = true)]
        public IDictionary<string, object> Properties {get; set; }

        public void Convert(dynamic result)
        {
            var app = JsonConvert.DeserializeObject<LuisResultModel>(JsonConvert.SerializeObject(result));
            Text = app.Text;
            AlteredText = app.AlteredText;
            Intents = app.Intents;
            Entities = app.Entities;
            Properties = app.Properties;
        }

        public (Intent intent, double score) TopIntent()
        {
            Intent maxIntent = Intent.None;
            var max = 0.0;
            foreach (var entry in Intents)
            {
                if (entry.Value.Score > max)
                {
                    maxIntent = entry.Key;
                    max = entry.Value.Score.Value;
                }
            }
            return (maxIntent, max);
        }
    }
}
```


## References:
- [Locally develop and manage LUIS applications with new BotBuilder tools](https://blog.botframework.com/2018/06/26/locally-develop-and-manage-luis-applications-with-new-botbuilder-tools)

- [Extract intents and entities using LUISGen](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-howto-v4-luisgen?view=azure-bot-service-4.0&tabs=cs)
